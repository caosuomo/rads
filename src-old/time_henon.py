#!/usr/bin/python

import numpy as np
from rads.enclosure import CombEnc,Tree
from rads.maps import HenonMapper
from rads.graphs.algorithms import graph_mis
from rads.misc import gfx
import time
import pickle

depth = 10
trials = 1#12

funcs = ['subdivide','update','graph_mis','remove']
times = np.zeros((len(funcs),depth,trials))

if __name__ == "__main__":
	for n in range(trials):
		box = np.array([[-2.0,-2],[4,4]])
		tree = Tree(box,full=True)
		m = HenonMapper()
		ce = CombEnc(tree,m)
		for d in range(depth):
			print 'depth', d
			t = time.time()
			ce.tree.subdivide()
			times[0,d,n] = time.time()-t
			print 'subdivided:', ce.tree.size, 'boxes'
			t = time.time()
			ce.update()
			times[1,d,n] = time.time()-t
			print 'updated'
			t = time.time()
			I = graph_mis(ce.mvm)
			times[2,d,n] = time.time()-t
			print 'len(I) = ', len(I)
			t = time.time()
			ce.tree.remove(list(set(range(ce.tree.size))-set(I)))
			times[3,d,n] = time.time()-t
			print 'removed'

	boxes = ce.tree.boxes()
	gfx.show_uboxes(boxes, col='c', ecol='b')

	# print times
	pickle.dump(times,file('henon-times.pickle','w'))
else:

	import scipy.io
	import scipy.stats as stats
	import matplotlib.pyplot as plt

	ptimes = np.array([[[  1.40666962e-05,   2.38418579e-05,   2.69412994e-05,   2.88486481e-05,   2.50339508e-05,   2.69412994e-05,   3.29017639e-05,   2.90870667e-05,   2.78949738e-05,   2.69412994e-05,   2.81333923e-05,   3.38554382e-05],[  1.00135803e-05,   1.50203705e-05,   3.38554382e-05,   3.00407410e-05,   1.69277191e-05,   1.78813934e-05,   3.19480896e-05,   3.19480896e-05,   3.09944153e-05,   3.69548798e-05,   1.19209290e-05,   3.69548798e-05],[  1.59740448e-05,   1.59740448e-05,   1.59740448e-05,   2.09808350e-05,   1.78813934e-05,   1.71661377e-05,   1.69277191e-05,   1.59740448e-05,   1.28746033e-05,   1.90734863e-05,   2.00271606e-05,   1.81198120e-05],[  2.71797180e-05,   3.09944153e-05,   3.50475311e-05,   3.60012054e-05,   3.29017639e-05,   3.91006470e-05,   3.29017639e-05,   2.88486481e-05,   2.90870667e-05,   3.29017639e-05,   3.60012054e-05,   3.29017639e-05],[  5.69820404e-05,   5.88893890e-05,   5.69820404e-05,   6.10351562e-05,   5.50746918e-05,   5.91278076e-05,   6.19888306e-05,   7.08103180e-05,   6.41345978e-05,   5.91278076e-05,   5.50746918e-05,   5.60283661e-05],[  1.34944916e-04,   1.27077103e-04,   1.40190125e-04,   1.27077103e-04,   1.41143799e-04,   1.29938126e-04,   1.25885010e-04,   1.26838684e-04,   1.24931335e-04,   1.36852264e-04,   1.27077103e-04,   1.38044357e-04],[  3.13043594e-04,   3.31163406e-04,   3.35931778e-04,   2.93016434e-04,   3.26156616e-04,   3.46899033e-04,   3.75986099e-04,   3.28063965e-04,   3.38077545e-04,   3.31878662e-04,   3.27825546e-04,   3.29971313e-04],[  6.63042068e-04,   7.13109970e-04,   6.86883926e-04,   6.79969788e-04,   7.29084015e-04,   7.29084015e-04,   7.06911087e-04,   6.92844391e-04,   6.79016113e-04,   6.89029694e-04,   7.41004944e-04,   7.17878342e-04],[  1.64890289e-03,   1.67489052e-03,   1.68585777e-03,   1.65200233e-03,   1.70183182e-03,   1.68204308e-03,   1.61814690e-03,   1.70588493e-03,   1.61719322e-03,   1.67989731e-03,   1.71089172e-03,   1.69301033e-03],[  3.91006470e-03,   4.02903557e-03,   4.02283669e-03,   4.02092934e-03,   4.01592255e-03,   4.01997566e-03,   4.01806831e-03,   4.02998924e-03,   4.02593613e-03,   3.96609306e-03,   4.03404236e-03,   3.99208069e-03]],       [[  6.38961792e-04,   1.49679184e-03,   1.52301788e-03,   1.43384933e-03,   1.66296959e-03,   1.43790245e-03,   1.50680542e-03,   1.43909454e-03,   1.43098831e-03,   1.65295601e-03,   1.51896477e-03,   1.65200233e-03],[  2.82406807e-03,   2.83384323e-03,   3.03983688e-03,   2.81596184e-03,   3.02505493e-03,   2.82192230e-03,   2.82716751e-03,   2.82979012e-03,   2.83217430e-03,   3.02815437e-03,   3.45993042e-03,   3.02505493e-03],[  5.78188896e-03,   5.82790375e-03,   6.26397133e-03,   6.20198250e-03,   6.29210472e-03,   6.24990463e-03,   5.91897964e-03,   5.80811501e-03,   5.85985184e-03,   6.27207756e-03,   6.27708435e-03,   6.28590584e-03],[  1.16419792e-02,   1.18339062e-02,   1.10809803e-02,   1.14610195e-02,   1.10461712e-02,   1.14238262e-02,   1.16717815e-02,   1.18491650e-02,   1.17928982e-02,   1.11420155e-02,   1.11310482e-02,   1.13899708e-02],[  3.09178829e-02,   2.97708511e-02,   2.99179554e-02,   2.95901299e-02,   2.98328400e-02,   2.95109749e-02,   2.95720100e-02,   2.96688080e-02,   2.97410488e-02,   2.96080112e-02,   2.98130512e-02,   2.98922062e-02],[  7.76038170e-02,   7.88240433e-02,   8.01320076e-02,   7.85179138e-02,   7.92419910e-02,   7.82389641e-02,   7.88600445e-02,   7.85369873e-02,   7.84711838e-02,   8.01701546e-02,   7.89818764e-02,   7.92250633e-02],[  1.97667122e-01,   1.98582888e-01,   1.99232101e-01,   2.05977917e-01,   2.00459003e-01,   1.98875904e-01,   1.99527979e-01,   1.99725151e-01,   2.08315134e-01,   1.98774099e-01,   1.99771881e-01,   1.99201822e-01],[  4.73441839e-01,   4.90846872e-01,   4.89480019e-01,   4.73938942e-01,   4.77051973e-01,   4.74001169e-01,   4.92667913e-01,   4.85121965e-01,   4.74352121e-01,   4.75003958e-01,   4.76368904e-01,   4.89517927e-01],[  1.18818307e+00,   1.15909600e+00,   1.19521189e+00,   1.18539786e+00,   1.18736291e+00,   1.17928505e+00,   1.16145897e+00,   1.19200301e+00,   1.18480206e+00,   1.17966485e+00,   1.17645192e+00,   1.19673204e+00],[  2.89537692e+00,   2.95201492e+00,   2.93420792e+00,   2.90217304e+00,   2.89428210e+00,   2.96225786e+00,   2.94563603e+00,   2.91421103e+00,   2.90991306e+00,   2.88293099e+00,   2.97609115e+00,   2.93859506e+00]],       [[  3.75986099e-04,   1.00493431e-03,   1.16610527e-03,   1.04117393e-03,   1.18899345e-03,   1.01208687e-03,   1.01208687e-03,   1.02210045e-03,   1.00588799e-03,   1.20592117e-03,   6.38961792e-04,   1.19686127e-03],[  4.99963760e-04,   4.92095947e-04,   5.53846359e-04,   5.04970551e-04,   5.55992126e-04,   5.26905060e-04,   4.90903854e-04,   4.92095947e-04,   4.88042831e-04,   5.50031662e-04,   5.60998917e-04,   5.53846359e-04],[  1.07812881e-03,   1.12414360e-03,   1.14798546e-03,   1.11603737e-03,   1.12414360e-03,   1.12509727e-03,   1.11317635e-03,   1.00708008e-03,   1.05786324e-03,   1.04498863e-03,   1.15799904e-03,   1.07192993e-03],[  1.83105469e-03,   1.72495842e-03,   1.74999237e-03,   1.70993805e-03,   1.69610977e-03,   1.71995163e-03,   1.82390213e-03,   1.86491013e-03,   1.85990334e-03,   1.70302391e-03,   1.75905228e-03,   1.71804428e-03],[  5.46407700e-03,   5.52105904e-03,   5.59902191e-03,   5.51295280e-03,   5.58805466e-03,   5.50103188e-03,   5.56802750e-03,   5.53297997e-03,   5.52916527e-03,   5.59091568e-03,   5.53607941e-03,   5.60998917e-03],[  1.92489624e-02,   2.02510357e-02,   1.94809437e-02,   1.88848972e-02,   1.93250179e-02,   2.02460289e-02,   1.92589760e-02,   1.95651054e-02,   1.94351673e-02,   1.96628571e-02,   1.99229717e-02,   1.94289684e-02],[  7.32522011e-02,   7.34181404e-02,   7.43079185e-02,   7.46369362e-02,   7.38339424e-02,   7.37299919e-02,   7.39400387e-02,   7.39891529e-02,   7.43629932e-02,   7.38010406e-02,   7.46860504e-02,   7.34989643e-02],[  3.10004950e-01,   3.11985016e-01,   3.11311960e-01,   3.10774088e-01,   3.11069012e-01,   3.11087132e-01,   3.14988852e-01,   3.10734987e-01,   3.10442924e-01,   3.12714100e-01,   3.11249018e-01,   3.11532021e-01],[  1.63091207e+00,   1.67970109e+00,   1.63899994e+00,   1.64026999e+00,   1.63628912e+00,   1.64291406e+00,   1.68110108e+00,   1.63886499e+00,   1.63586211e+00,   1.63834095e+00,   1.64201307e+00,   1.63943291e+00],[  8.52652597e+00,   8.43574286e+00,   8.44531107e+00,   8.52527690e+00,   8.54427290e+00,   8.49123693e+00,   8.43452883e+00,   8.52362514e+00,   8.54098606e+00,   8.53042483e+00,   8.47388601e+00,   8.44146800e+00]],       [[  1.19209290e-05,   3.00407410e-05,   2.00271606e-05,   2.81333923e-05,   3.91006470e-05,   3.60012054e-05,   1.59740448e-05,   1.69277191e-05,   1.78813934e-05,   2.09808350e-05,   1.50203705e-05,   2.09808350e-05],[  2.19345093e-05,   2.40802765e-05,   2.69412994e-05,   2.59876251e-05,   2.78949738e-05,   2.69412994e-05,   2.50339508e-05,   2.50339508e-05,   2.19345093e-05,   2.81333923e-05,   2.90870667e-05,   2.78949738e-05],[  3.50475311e-05,   3.91006470e-05,   4.38690186e-05,   4.41074371e-05,   4.00543213e-05,   4.60147858e-05,   4.10079956e-05,   3.50475311e-05,   3.48091125e-05,   3.79085541e-05,   4.00543213e-05,   3.91006470e-05],[  6.60419464e-05,   6.79492950e-05,   6.29425049e-05,   7.29560852e-05,   6.19888306e-05,   6.81877136e-05,   7.29560852e-05,   7.29560852e-05,   7.00950623e-05,   7.91549683e-05,   6.10351562e-05,   6.00814819e-05],[  1.32083893e-04,   1.37090683e-04,   1.49965286e-04,   1.40190125e-04,   1.53064728e-04,   1.38044357e-04,   1.35898590e-04,   1.37090683e-04,   1.39951706e-04,   1.48057938e-04,   1.40190125e-04,   1.49965286e-04],[  3.64065170e-04,   3.85999680e-04,   3.98159027e-04,   3.15904617e-04,   3.95774841e-04,   3.98159027e-04,   3.83853912e-04,   3.78847122e-04,   4.14848328e-04,   3.89099121e-04,   3.84092331e-04,   3.91006470e-04],[  7.88927078e-04,   7.71999359e-04,   8.27074051e-04,   7.81059265e-04,   8.28981400e-04,   8.05139542e-04,   7.76052475e-04,   8.38994980e-04,   8.26835632e-04,   8.36849213e-04,   8.28027725e-04,   7.99894333e-04],[  1.72710419e-03,   1.86610222e-03,   1.80602074e-03,   1.81889534e-03,   1.82008743e-03,   1.84893608e-03,   1.89614296e-03,   1.81508064e-03,   1.92999840e-03,   1.86491013e-03,   1.84202194e-03,   1.83606148e-03],[  4.41598892e-03,   4.39715385e-03,   4.36997414e-03,   4.33516502e-03,   4.41789627e-03,   4.36615944e-03,   4.34803963e-03,   4.32801247e-03,   4.41694260e-03,   4.42004204e-03,   4.40001488e-03,   4.35709953e-03],[  1.10030174e-02,   1.09601021e-02,   1.11258030e-02,   1.09770298e-02,   1.09369755e-02,   1.10108852e-02,   1.11451149e-02,   1.09519958e-02,   1.09870434e-02,   1.08969212e-02,   1.10008717e-02,   1.09078884e-02]]])

	# mat = scipy.io.loadmat('/home/raf/projects/ds/matlab/rads/mtest_times.mat')
	# mtimes = mat['times'][0]

	mtimes = pickle.load(file('henon-times.pickle','r'))

	x = np.arange(1,depth)
	data = mtimes[2][x,:]/ptimes[2][x,:]
	y = np.mean(data,axis=1)
	e = 2*stats.sem(data,axis=1)

	fgcolor = np.array([20,50,100])/255.
	bgcolor = 0.9 + 0.1*fgcolor
	ngreen = np.array([98,158,31])/255.
	nred = np.array([120,20,10])/255.
	plt.rcdefaults()
	plt.rcParams['figure.subplot.right']='0.9'
	plt.rcParams['figure.subplot.left']='0.2'
	plt.rcParams['figure.subplot.top']='0.8'
	plt.rcParams['ytick.major.pad']='10'
	plt.rcParams['ytick.color']=fgcolor
	plt.rcParams['xtick.color']=fgcolor
	plt.rcParams['ytick.major.size']=4
	plt.rcParams['xtick.major.size']=4
	plt.rc('lines', linewidth=2)
	plt.rc('text', color=fgcolor)
	plt.rc('axes', linewidth=2, facecolor=bgcolor, edgecolor=fgcolor, labelcolor=fgcolor)

	plt.close('all')
	plt.figure(frameon=False)
	plt.errorbar(x, y, yerr=e,
				 marker='o',
				 color=ngreen,
				 ecolor=fgcolor,
				 elinewidth=1,
				 markerfacecolor=ngreen,
				 capsize=5,
				 linestyle='-')

	# plt.xlim(x[0]-0.4,x[-1]+0.4)
	# plt.ylim(10.6,13.8)
	plt.xlabel('depth',size='large')
	plt.ylabel('speedup = matlab/python',size='large')
#	plt.savefig('/home/raf/Dropbox/cs262a/report/enclosures.pdf',bbox_inches='tight')
	plt.show()
	screwup
	
